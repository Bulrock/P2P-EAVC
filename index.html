<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>P2P E2E AV Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Peer-to-peer end-to-end encrypted video, audio, and chat with secure file sharing and reactions." />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="preload" href="style.css" as="style" />
  <link rel="modulepreload" href="script.js" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* Reserve space for cards to reduce CLS */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      padding: 1rem;
      min-height: 0;
    }
    @media (min-width: 900px) {
      main {
        grid-template-columns: 1.2fr 0.8fr;
        overflow: visible;
      }
    }
    .card {
      background: #020617;
      border-radius: 1rem;
      border: 1px solid #1f2937;
      padding: 1rem;
      min-height: 200px;
    }
    .card:last-child {
      max-height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }
  </style>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<header>
  <div class="lock-badge">
    <span>ğŸ”’ E2E P2P Chat</span>
    <span>AES-256 â€¢ WebRTC</span>
  </div>

  <div class="mode-select" style="align-items:center; width:100%; justify-content:flex-start; position:relative;">
    <span style="font-size:0.8rem; margin-right:0.4rem;">Host</span>

    <label class="switch" for="modeToggle" aria-label="Toggle Host or Guest mode">
      <input type="checkbox" id="modeToggle">
      <span class="slider"></span>
    </label>

    <span style="font-size:0.8rem; margin-left:0.4rem;">Guest</span>

    <!-- Disconnect button floating on the right -->
    <button id="btnDisconnect" class="secondary small" disabled 
            style="position:absolute; right:0; top:50%; transform:translateY(-50%);">
      Disconnect
    </button>
  </div>
</header>

<main>
  <!-- LEFT: Signaling + Video -->
  <section class="card" id="connCard">
    <h2 id="connHeader" class="accordion-header">
      <span>Connection &amp; Media</span>
      <span class="status-line">
        <span id="connDot" class="status-dot"></span>
        <span id="connStatus">Disconnected</span>
        <span id="connChevron">â–¾</span>
      </span>
    </h2>

    <div id="connBody" class="accordion-body">
      <h3 id="flowHeader" class="accordion-header">
        <span><span id="flowTitle">Host flow</span> <span id="flowPill" class="pill">You start the call</span></span>
        <span id="flowChevron">â–¾</span>
      </h3>
      <div id="flowSection">

        <!-- HOST SECTION -->
        <div id="hostSection">
          <div class="row">
            <button id="btnCreateOffer">1. Host: Create offer</button>
            <button id="btnReset" class="secondary small">Reset</button>
          </div>
  
          <label class="label" for="offerOut">Offer blob (send to guest)</label>
          <div class="row">
            <textarea id="offerOut"></textarea>
            <button class="secondary small" id="btnCopyOffer">Copy</button>
          </div>
  
          <label class="label" for="answerIn">Answer blob from guest</label>
          <div class="row">
            <textarea id="answerIn"></textarea>
            <button class="secondary small" id="btnApplyAnswer">Apply</button>
          </div>
        </div>
  
        <!-- GUEST SECTION -->
        <div id="guestSection">

          <label class="label" for="offerIn">Offer blob from host</label>
          <textarea id="offerIn"></textarea>
  
          <div class="row">
            <button id="btnAcceptOffer">2. Guest: Accept offer</button>
          </div>
  
          <div class="label">Your answer blob</div>
          <div class="row">
            <textarea id="answerOut"></textarea>
            <button id="btnCopyAnswerGuest" class="secondary small">Copy</button>
          </div>
        </div>
      </div>

      <!-- MEDIA -->
      <h3>Media</h3>
      <label class="status-line">
        <input type="checkbox" id="chkMedia" />
        <span>Use camera &amp; mic (optional â€” check to enable)</span>
      </label>

      <!-- VIDEO WRAPPER (hidden by default) -->
      <div id="videoWrapper">
        <div class="videos">
          <div>
            <div class="label">You</div>
            <video id="localVideo" autoplay playsinline muted></video>
          </div>
          <div>
            <div class="label">Guest</div>
            <video id="remoteVideo" autoplay playsinline></video>
          </div>
        </div>
      </div>

      <h3 id="logHeader" class="accordion-header">Log â–¾</h3>
      <div id="logBody">
        <div class="logs" id="log"></div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Chat -->
  <section class="card">
    <h2>
      Secure chat
      <span class="pill">AES-GCM + DataChannel</span>
    </h2>

      <div class="chat-box">
      <div class="chat-messages" id="chatMessages"></div>

      <div class="chat-input-row">
        <div class="chat-text-wrap" style="width:100%; gap:0.3rem;">
          <textarea id="chatInput" class="chat-input" placeholder="Type a messageâ€¦" style="flex:1 1 auto; width:100%; min-height:64px; max-height:160px; height:64px; resize:vertical; overflow-y:auto; border-radius:0.75rem;"></textarea>
        </div>

        <div class="chat-text-wrap" style="width:100%; gap:0.3rem; margin-top:0.4rem; flex-wrap:nowrap;">
          <label for="emojiSelect" class="sr-only">Choose emoji</label>
          <select id="emojiSelect" class="chat-input" style="flex:1 0 25%; max-width:25%; min-width:90px; height:40px; padding: 0 0.2rem; line-height:40px;">
            <option value="">ğŸ™‚ Emojis</option>
            <option>ğŸ˜€</option><option>ğŸ˜</option><option>ğŸ˜‚</option><option>ğŸ¤£</option><option>ğŸ˜Š</option>
            <option>ğŸ˜</option><option>ğŸ¤©</option><option>ğŸ˜˜</option><option>ğŸ˜</option><option>ğŸ¤”</option>
            <option>ğŸ˜‡</option><option>ğŸ˜…</option><option>ğŸ™ƒ</option><option>ğŸ˜´</option><option>ğŸ¤¯</option>
            <option>ğŸ˜±</option><option>ğŸ¤—</option><option>ğŸ‘</option><option>ğŸ™</option><option>ğŸ‰</option>
            <option>ğŸ”¥</option><option>ğŸŒŸ</option><option>ğŸ’¡</option><option>â¤ï¸</option><option>ğŸ§ </option>
            <option>ğŸ’©</option>
          </select>
          <input id="photoInput" type="file" accept="*/*" style="display:none;" />
          <button id="btnPhoto" class="secondary small" type="button" style="height:40px; flex:0 1 40px; justify-content:center; font-size:1.3rem;">ğŸ“</button>
          <button id="btnRecord" class="secondary small" type="button" style="height:40px; flex:0 1 40px; justify-content:center; font-size:1.3rem;">ğŸ¤</button>
          <button id="btnSend" style="height:40px; flex:1 1 auto; justify-content:center; font-size: 0.9rem; color: white;">Send</button>
        </div>
      </div>

      <div class="status-line">
        ğŸ’¬ <span id="chatStatus">DataChannel: not ready</span>
      </div>
    </div>
  </section>
</main>

<footer>
  <span>Close/reload = all keys gone</span>
</footer>

<script type="module" src="script.js"></script>

</body>
</html>
